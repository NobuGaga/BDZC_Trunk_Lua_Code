--商会管理界面

----------------------文件引用--------------------------
--@RefType [Libs.WindowMgr.WindowBase.bytes#_M]
local WindowBase = JRequire "Libs.WindowMgr.WindowBase"
--@RefType [Libs.WindowMgr.WindowOpen.bytes#_M]
local WindowOpen = JRequire "Libs.WindowMgr.WindowOpen"
--@RefType [Dev.Commerce.CCommerce.bytes#_M]
local CCommerce = JRequire "Dev.Commerce.CCommerce"
--@RefType [Dev.Commerce.MCommerce.bytes#_M]
local MCommerce = JRequire "Dev.Commerce.MCommerce"
--@RefType [Dev.Common.CCommon.bytes#_M]
local CCommon = JRequire "Dev.Common.CCommon"
local SoundMgr = JRequire "Libs.Sound.SoundMgr"
----------------------常量定义--------------------------

--外部接口模块 *** 只放置共有接口, 禁止放变量
local _M = Class(WindowBase)
--私有函数模块 *** 只放置私有函数, 禁止放变量
local _P = {}
--外部刷新接口 *** 只放置外部Call的接口, 禁止放变量
local _R = {}

function _R.OnUpdatemeMyInfo(self)
	local myInfo = MCommerce.MyCommerceInfo.myInfo
	if self.Job ~= myInfo.job then
		self.Job = myInfo.job

		if self.Job == MCommerce.JobType.HuiZhang or self.Job == MCommerce.JobType.FuHuiZhang then
			_P.UpdateBtns(self)
		else
			self:Destroy()
		end
	end
end

function _P.UpdateBtns(self)
	local moudle = self.Moudle
	if self.Job == MCommerce.JobType.HuiZhang then
		moudle:Get("Btn3").Activity = true
		moudle:Get("Btn4").Activity = true
		--会长转让
		moudle:Get("BtnText3").Text = Csv.Text("commerce_manager3")
		moudle:Get("Btn3"):AddOnButton(function()
			SoundMgr.Play(10001)
			WindowMgr.Create("UCommerceTransfer")
		end)
		--解散商会
		moudle:Get("BtnText4").Text = Csv.Text("commerce_manager4")
		moudle:Get("Btn4"):AddOnButton(function()
			SoundMgr.Play(10001)
			local info = MCommerce.MyCommerceInfo
			if info ~= nil then
				local csv = Csv.Commerce[info.level]
				local time = Csv.Const(20166)
				CCommon.CheckTips(function (isSure)
					if isSure then
						CCommerce.DisbandReq("123456")
					end
				end, {content = Csv.Text("commerce_manager5", {leavePer = csv.leavePer, time = time})})
			end
		end)
	else
		moudle:Get("Btn1").Activity = false
		moudle:Get("Btn3").Activity = false
		moudle:Get("Btn4").Activity = false
	end
end

--外部调用派发器
function _M:Dispatch(funcName, ...)
	local fun = _R[funcName]
	if fun ~= nil then
		fun(self, ...)
	end
end

--界面构建
function _M:OnCreate()
	local moudle = self:CreateMoudle(self._RootNode, "M_Gang_Main_Administration")
	moudle:Get("C_Back_Btn"):AddOnButton(function ( ... )
		SoundMgr.Play(10002)
		self:Destroy()
	end, nil, 1.2)

	self.Moudle = moudle
	if MCommerce.MyCommerceInfo ~= nil then
		local myInfo = MCommerce.MyCommerceInfo.myInfo
		self.Job = myInfo.job
		moudle:Get("title").Text = Csv.Text("commerce_manager1")

		--商会信息
		moudle:Get("BtnText1").Text = Csv.Text("commerce_detail1")
		moudle:Get("Btn1"):AddOnButton(function ()
			SoundMgr.Play(10001)
			WindowMgr.Create("UCommerceUpdateInfo")
		end)
		--入会申请
		moudle:Get("BtnText2").Text = Csv.Text("commerce_manager2")
		moudle:Get("Btn2"):AddOnButton(function ()
			SoundMgr.Play(10001)
			WindowMgr.Create("UCommerceOperateApply")
		end)
		_P.UpdateBtns(self)

		moudle:Get("redPoint").Activity = (MCommerce.MyCommerceInfo.haveApply ~= nil and MCommerce.MyCommerceInfo.haveApply == true)
	end
end

function _R.SetRedpointHidden(self)
	local moudle = self.Moudle
	moudle:Get("redPoint").Activity = (MCommerce.MyCommerceInfo.haveApply ~= nil and MCommerce.MyCommerceInfo.haveApply == true)
end

return _M