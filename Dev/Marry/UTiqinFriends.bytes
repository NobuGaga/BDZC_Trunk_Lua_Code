local JGuiManager = CS.JGui.JGuiManager
local MFriend = JRequire "Dev.Friend.MFriend"
local CFriend = JRequire "Dev.Friend.CFriend"
local WindowBase = JRequire"Libs.WindowMgr.WindowBase"
local WindowType = JRequire "Libs.WindowMgr.WindowType"
local CCommon = JRequire"Dev.Common.CCommon"
local TabGroup = JRequire "Dev.Common.TabGroup2"
local luaUtil = JRequire"Libs.LuaUtil"
local MGirl = JRequire "Dev.Girl.MGirl"
local CGirl = JRequire"Dev.Girl.CGirl"
local MBag = JRequire "Dev.Bag.MBag"
local CBag = JRequire "Dev.Bag.CBag"
local SoundMgr = JRequire "Libs.Sound.SoundMgr"
local MPlayer = JRequire "Dev.Player.MPlayer"


local _M = Class(WindowBase)
local _P = {}
local _R = {}

function _M:Dispatch(funcName, ...)
	local fun = _R[funcName]
	if fun ~= nil then 
		fun(self, ...)
	end
end

function _R.SetFriendQinjia(self,msg)
	local list = self.mFriendMsgList
	if list == nil then
		list = {}
	end
	if msg.list ~= nil then
		for k,v in pairs(msg.list)do
			if list[v.id] == nil then
				print("relation____________",v.relation)
				list[v.id] = v
			end
		end
	end
	self.mFriendMsgList = list

	_P.SetFriendItems(self)
end

function _M:ctor(parent)
	self._RootNode = parent
	local moudle = JGuiManager.GetMoudle(self._RootNode, "M_Girl_Married_Tiqin1", WindowType.UI, 0)
	self.mMoudle = moudle

	moudle:Get("TabText1").Text = Csv.Text("married_tiqin_tab1")
	moudle:Get("TabText2").Text = Csv.Text("married_tiqin_tab2")
	moudle:Get("C_text").Text = Csv.Text("married_tiqin_look")

	local content = moudle:Get("content")
	
	--查看子女信息
	moudle:Get("C_Btn_a"):AddOnButton(function()
		print("look_____________",self.selectFriendId)
	end,nil,1.2)

	--往右
	moudle:Get("JT1"):AddOnButton(function()
		_P.OnClickNext(self,1)
	end,nil,1.2)

	--往左
	moudle:Get("JT2"):AddOnButton(function()
		_P.OnClickNext(self,-1)
	end,nil,1.2)

	local relation1 = MFriend.FuncToRelation[Define.SysId.Friend_Friend]
	local relation2 = MFriend.FuncToRelation[Define.SysId.Friend_Qinjia]
	CFriend.ReqLook(relation1)
	CFriend.ReqLook(relation2)

end

function _P.SetFriendItems(self)
	local moudle = self.mMoudle
	local content = moudle:Get("content")

	content:DestroyChildren()

	local friendItemTab = {}
	local friendList = self.mFriendMsgList
	if friendList ~= nil then
		local index = 0
		for k,v in pairs(friendList)do
			index = index+1
			local _item = _P.CreateFriendItem(self,content,v,index)
			friendItemTab[index] = {id = v.id,data = v,item = _item}
		end
	end
	self.mFrinedItems = friendItemTab

	_P.ClickFriendItem(self,1)
end

function _P.OnClickNext(self,num)
	if self.mSelectItemIndex == nil then
		self.mSelectItemIndex = 1
	end
	local index = self.mSelectItemIndex + num

	local friendItems = self.mFrinedItems
	if friendItems ~= nil then
		if index <= 0 or index > #friendItems then
			return
		end
	else
		return
	end

	self.mSelectItemIndex = index
	_P.ClickFriendItem(self,index)
end

function _P.ClickFriendItem(self,index)
	local friendItems = self.mFrinedItems
	
	local itemMoudle = self.mSelectItem
	if itemMoudle ~= nil then
		itemMoudle:Get("select").Activity = false
	end

	local item = friendItems[index]
	
	if item ~= nil then
		itemMoudle = item.item
		itemMoudle:Get("select").Activity = true
		_P.RefreshInfo(self,index)

		self.mSelectItem = itemMoudle
	end
end

function _P.RefreshInfo(self,index)
	local itemData = self.mFrinedItems[index]
	self.selectFriendId = itemData.id
	local data = itemData.data
	if data == nil then
		print("找不到好友数据id__________",id)
		return
	end
	
	local moudle = self.mMoudle

	local bsxImg = moudle:Get("bxs")
	local tab1 = moudle:Get("Tab1")
	local tab2 = moudle:Get("Tab2")
	local name = moudle:Get("Name")
	local num = moudle:Get("Num")
	local powerText = moudle:Get("SL")
	local levelText = moudle:Get("DJ")
	local babyText = moudle:Get("SH")

	tab2.Activity = false
	if data.relation == 3 then
		tab2.Activity = true
	end

	name.Text = data.name
	num.Text = Csv.Text("married_tiqin_num",{id = data.id})
	powerText.Text = Csv.Text("married_power",{num = data.power})
	levelText.Text = Csv.Text("married_level",{num = data.level})
	babyText.Text = Csv.Text("married_baby",{num = _P.GetBabyNums(self)})
end

function _P.CreateFriendItem(self,content,data,index)
	local moudle = JGuiManager.GetMoudle(content, "M_Girl_Married_Tiqin1_Item", WindowType.UI, 10)

	local head = moudle:Get("Head")
	head.SpriteName = MPlayer.HeadIconFromSex(data.headId,data.sex,true)

	head:AddOnClick(function()
		_P.ClickFriendItem(self,index)
	end)

	return moudle
end

function _P.GetBabyNums(self)
	return 5
end


function _M:Destroy()
	local moudle = self.mMoudle
	if moudle ~= nil then
		moudle:Destroy()
	end
end

return _M