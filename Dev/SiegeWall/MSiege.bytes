
local EventCenter = JRequire "Dev.EventCenter"
local HeartBeat = JRequire "Dev.Player.HeartBeat"
local MPlayer = JRequire "Dev.Player.MPlayer"
local MStaff = JRequire "Dev.Staff.MStaff"
local MCommerce = JRequire "Dev.Commerce.MCommerce"
local CSiege = JRequire "Dev.SiegeWall.CSiege"
local CCommon = JRequire "Dev.Common.CCommon"

local _M = {}
local _P = {}

_M.MaxPoint = 10

_M.TreasureEnum = {
	None = 0,
	Mine = 1,
	Disk = 2,
	Order = 3,
}
_M.RankTypeEnum = {
	Personal = 1,
	Gang = 2,
	Killed = 3,
}

_M.ActivityState = false --活动开关
_M.StartTime = 0
_M.EndTime = 0
_M.ActivityId = 1 --活动id
_M.Phase = 1 --阶段
_M.OpenTime = 0 --开启CD(等待中开始)
_M.PointCD = 1000
_M.Progress = {} --进度，列表，第二阶段有3个进度
_M.LastUdisk = nil --剩余U盘数量，总数
_M.Buffs = {}
_M.lastEnmey = 0 --剩余敌人数量，第三阶段
_M.BigBoss = {} --第二阶段3只
_M.Teams = {}
_M.RecoveStaffs = {} --已使用过复活的员工（策划说同一阶段同个员工只能复活一次）
_M.DieStaffs = {} --已死亡的员工（每个boss都不一样）
_M.BossList = {}

_M.ActionPoint = 0--行动点
_M.ActionBuy = 0--行动点购买次数
_M.RecoveTime = 0 --恢复时间
_M.isRecoveTick = false
_M.RecoveHandle = nil 
_M.SelectHero = nil
_M.BossList = {}
--[[
_M.Teams = {{type = 1,bossId = 3,commerce = {{key = 1,name = "1"},{key = 2,name = "2"}}},
			{type = 2,bossId = 3,commerce = {{key = 1,name = "1"},{key = 2,name = "2"}}},
			{type = 3,bossId = 3,commerce = {{key = 1,name = "1"},{key = 2,name = "2"}}}} --阵营信息	
_M.BossList = {{indexID = 1,id = 1,bossBlood = {ncur = 1000,nmax = 1000},discoverer = "1",commerceId = 1},
				{indexID = 2,id = 2,bossBlood = {ncur = 1000,nmax = 1000},discoverer = "2",commerceId = MCommerce.MyCommerceId},
				{indexID = 3,id = 3,bossBlood = {ncur = 1000,nmax = 1000},discoverer = "3",commerceId = 1},
				{indexID = 4,id = 1,bossBlood = {ncur = 1000,nmax = 1000},discoverer = "4",commerceId = 1},
				{indexID = 5,id = 2,bossBlood = {ncur = 1000,nmax = 1000},discoverer = "5",commerceId = MCommerce.MyCommerceId},
				{indexID = 6,id = 2,bossBlood = {ncur = 1000,nmax = 1000},discoverer = "6",commerceId = 1},
				{indexID = 7,id = 1,bossBlood = {ncur = 1000,nmax = 1000},discoverer = "7",commerceId = MCommerce.MyCommerceId},
				{indexID = 8,id = 2,bossBlood = {ncur = 1000,nmax = 1000},discoverer = "8",commerceId = 1},
				{indexID = 9,id = 1,bossBlood = {ncur = 1000,nmax = 1000},discoverer = "9",commerceId = 1},
				{indexID = 10,id = 1,bossBlood = {ncur = 1000,nmax = 1000},discoverer = "10",commerceId = 1},}
--]]
_M.isFighting = false
_M.selectBossId = 0
_M.BossPower = {}
_M.AllStageData = {}
_M.RankSelfStageData = {}
_M.RankGangStageData = {}

function _M.Clean()
	_M.OpenTime = 0
	_M.selectBossId = 0
	_M.RecoveTime = 0
	_M.isRecoveTick = false
	_M.RecoveHandle = nil 
	_M.ActionPoint = 0
	_M.ActionBuy = 0
	_M.SelectHero = nil
	_M.isFighting = false

	_M.BossPower = {}
	_M.AllStageData = {}
	_M.BossList = {}
	_M.LastUdisk = nil
end

function _M.SiegeActivityStatus(data)
	_M.ActivityState = data.state
	_M.ActivityId = data.actid
	_M.StartTime = data.startTime
	_M.EndTime = data.endTime

	if Csv.Siege[_M.ActivityId] ~= nil then
		_M.MaxPoint = Csv.Siege[_M.ActivityId].maxTimes
		_M.PointCD = Csv.Siege[_M.ActivityId].CD
	end

	if _M.ActivityState == false then
		--刷新活动图标
		WindowMgr.Call("UMain","RefreshTopBtns")
	end
end

function _M.SetOpenTime(data)
	_M.OpenTime = data.starttime
end

function _M.SetAcitvityPhase(_acitvityId,_phase)
	_M.ActivityId = _acitvityId --活动id
	_M.Phase = _phase --阶段

	--[[
	if _phase ~= nil then
		CSiege.ReqSiegeStage() --请求阶段
	end
	--]]
end

function _M.SetSiegeStageMsg(data)
	_M.Phase = data.phase --阶段
	
	_M.Progress = {}
	if data.progress ~= nil then
		for k,v in pairs(data.progress)do
			local _progress = {type = v.type,progressCur = v.progressCur,progressMax = v.progressMax}
			table.insert(_M.Progress,_progress)
			--_M.Progress[v.type] = _progress
		end
	end

	_M.LastUdisk = nil
	if data.lastUdisk ~= nil then
		_M.LastUdisk = {ncur = data.lastUdisk.ncur,nmax = data.lastUdisk.nmax}
	end
	
	_M.Buffs = {}
	if data.buffs ~= nil then
		for k,v in pairs(data.buffs)do
			_M.Buffs[v.key] = v.value
			--table.insert(_M.Buffs,{key = v.key,value = v.value})
		end
	end

	_M.lastEnmey = 0
	if data.enemy ~= nil then
		_M.lastEnmey = data.enemy
	end

	_M.BigBoss = {}
	if data.boss ~= nil then
		for k,v in pairs(data.boss)do
			local boss = _P.BossMsg(v)
			if v.type ~= nil then
				_M.BigBoss[v.type] = boss
			else
				table.insert(_M.BigBoss,boss)
			end
		end
	end

	_M.RecoveStaffs  = {}
	if data.staffs ~= nil then
		for k,v in pairs(data.staffs)do
			_M.RecoveStaffs[v] = true
		end
	end

	_M.Teams = {}
	if data.teams ~= nil then
		for k,v in pairs(data.teams)do
			local _type = v.type
			local _bossId = v.bossId
			local _commerce = {}
			if v.commerce ~= nil then
				for k2,v2 in pairs(v.commerce)do
					table.insert(_commerce,{id = v2.key,name = v2.value})
				end
			end
			_M.Teams[_type] = {type = _type,bossId = _bossId,commerce = _commerce}
		end
	end
end

function _M.SetActionPoint(data)
	_M.ActionPoint = data.action

	_M.RecoveTime = 0
	if _M.ActionPoint < _M.MaxPoint then
		_M.RecoveTime = data.lastTime + HeartBeat.ServSecond()
	end
	_P.ReduceTime()
end

function _M.SetBossList(data)
	_M.BossList = {}
	if data.bossList ~= nil then
		for k,v in pairs(data.bossList)do
			local boss = _P.BossMsg(v)
			table.insert(_M.BossList,boss)
		end
	end
end

function _M.SetNewBuff(data)
	CCommon.ShowError(Csv.Text("siege_buy_buff_success"))
	if data.buff ~= nil then
		if _M.Buffs[data.buff.key] ~= nil then
			_M.Buffs[data.buff.key] = _M.Buffs[data.buff.key] + 1
		else
			_M.Buffs[data.buff.key] = 1
		end
	end
end

function _P.ReduceTime()
	local tick = _M.RecoveTime
	if tick > 0 then
		_M.isRecoveTick = true
		_M.RecoveHandle = EventCenter.RegistCallEvent(Define.EventListenId.SecondUpdate,function (eventHandle, now)
			local _tick = _M.RecoveTime
			if _tick > 0 then
				local leftTime = _tick - HeartBeat.ServSecond()
				if leftTime <= 0 then
					_M.ActionPoint = _M.ActionPoint +1 
					if _M.ActionPoint < _M.MaxPoint then
						_M.RecoveTime = _M.PointCD + HeartBeat.ServSecond()
					else
						_M.RecoveTime = 0
					end
					WindowMgr.Call("USiegeMain", "UpdateActionPoint")
				end
			else
				_M.isRecoveTick = false
				_M.RecoveHandle = nil
				EventCenter.UnRegistCallEvent(eventHandle)
			end
		end)
	end
end

function _P.DieStaffsInBoss(staffs)
	local _staffs = {}
	if staffs ~= nil then
		for k,v in pairs(staffs)do
			table.insert(_staffs,v)
		end
	end
	return _staffs
end

function _P.BossMsg(msg)
	local boss = {}

	local _staffId = {}
	if msg.staffId ~= nil then
		for k,v in pairs(msg.staffId)do
			table.insert(_staffId,v)
		end
	end
	
	boss = {indexID = msg.indexID,
			id = msg.id,
			bossBlood = {ncur = msg.bossBlood.ncur,nmax = msg.bossBlood.nmax},
			discoverer = msg.discoverer,
			commerceId = msg.commerceId,
			type = msg.type,
			staffId = _staffId}
	return boss
end

-------------
function _M.UnlockStaff(data)
	_M.RecoveStaffs = {}
	if data.staffs ~= nil then
		for k,v in pairs(data.staffs)do
			_M.RecoveStaffs[v] = true
		end
	end

	local dieStaff = _M.DieStaffs
	if dieStaff ~= nil then
		if dieStaff[data.staffid] ~= nil then
			dieStaff[data.staffid] = nil
		end
	else
		dieStaff = {}
	end
	_M.DieStaffs = dieStaff
end

function _M.SetDieStaffs(staffs)
	local dieStaff = {}
	if staffs ~= nil then
		for k,v in pairs(staffs)do
			dieStaff[v] = true
		end
	end
	_M.DieStaffs = dieStaff
end

function _M.NewDieStaff(staffid)
	local dieStaff = _M.DieStaffs
	if dieStaff ~= nil then
		dieStaff[staffid] = true
	else
		dieStaff = {}
		dieStaff[staffid] = true
	end
	_M.DieStaffs = dieStaff
end

--每个boss有自己的员工
--v={state:1派遣，2恢复,3,无效，times}
function _M.SelectStaff()
	local staffList = MStaff.StaffTable
	
	local biggerMods = {}
	local smallerMods = {}
	local _mod = 0

	local dieStaffs = _M.DieStaffs
	
	for k,v in pairs(staffList) do
		if dieStaffs[k] then
			
		else
			_mod = v.power-_M.BossPower.ncur
			if _mod >= 0 then
				table.insert(biggerMods,{id = k,mod = _mod})
			else
				table.insert(smallerMods,{id = k,mod = _mod})
			end
		end
	end
		
	local a_csv
	local b_csv
	if #biggerMods > 0 then
		table.sort(biggerMods, function( a, b )
			a_csv = a
			b_csv = b
			return a.mod < b.mod
		end)
	
		return MStaff.GetStaffDataByID(biggerMods[1].id)
	end
	if #smallerMods > 0 then
		table.sort(smallerMods, function( a, b )
			a_csv = a
			b_csv = b
			return a.mod > b.mod
		end)

		return MStaff.GetStaffDataByID(smallerMods[1].id)
	end
	return nil
end

--------------------------------------------------------------------------

function _M.GetTreasureListByStage(stageId)
	local listData = {}
	for k,v in pairs(Csv.SiegeTreasury) do
		if v.stage == nil or v.stage == 0 or v.stage == stageId then
			listData[#listData + 1] = v
		end
	end

	return listData
end

-- 设置各阶段兑换商店、排行版领取状态数据
function _M.SetAllStageData(stageList)
	local listData = {}
	if stageList ~= nil then
		for k,v in pairs(stageList) do
			listData[v.stage] = v
		end
	end
	
	_M.AllStageData = listData
end

--购买商品扣除
function _M.ReduceAllStageData(stage,_index,_goodid,_buycount)
	if _M.AllStageData[stage] ~= nil then
		local items = _M.AllStageData[stage].itemList
		if items ~= nil then
			for k,v in pairs(items)do
				if v.goodid == _goodid then
					v.buyCount = _buycount
					return
				end
			end
			table.insert(items,{index = _index,goodid = _goodid,buyCount = _buycount})
		else
			items = {}
			table.insert(items,{index = _index,goodid = _goodid,buyCount = _buycount})
		end
		_M.AllStageData[stage].itemList = items
	end
end

function _M.AddJifen(stage,jifen)
	if _M.AllStageData[stage] ~= nil then
		if _M.AllStageData[stage].point ~= nil then
			_M.AllStageData[stage].point = _M.AllStageData[stage].point + jifen
		else
			_M.AllStageData[stage].point = jifen
		end
	end
end

function _M.SetRankStage(data)
	local selfGetState = data.selfGetState
	local gangGetState = data.gangGetState

	if selfGetState ~= nil then
		for k,v in pairs(selfGetState)do
			_M.RankSelfStageData[v.key] = v.value
		end
	end
	if gangGetState ~= nil then
		for k,v in pairs(gangGetState)do
			_M.RankGangStageData[v.key] = v.value
		end
	end
	--状态通知
end

---------------------------------------------------------
function _M.GetBuffInfo(index)
	local buffs = _M.Buffs
	for k,v in pairs(buffs)do
		print("__buffs____",k,v)
		local buffData = Csv.SiegeBuff[k]
		if buffData.index == index then
			return {id = k,value = v}
		end
	end
	return nil
end

function _M.GetTeamType(commerceID)
	if _M.Teams ~= nil then
		for k,v in pairs(_M.Teams)do
			local type = v.type
			if v.commerce ~= nil then
				for k2,v2 in pairs(v.commerce)do
					if v2.id == commerceID then
						return type
					end
				end
			end
		end
	end
	return nil
end

return _M