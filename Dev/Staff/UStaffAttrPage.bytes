local JGuiManager = CS.JGui.JGuiManager
local WindowType = JRequire "Libs.WindowMgr.WindowType"
local MStaff = JRequire "Dev.Staff.MStaff"
local MBag = JRequire "Dev.Bag.MBag"
local SoundMgr = JRequire "Libs.Sound.SoundMgr"
local CStaff = JRequire "Dev.Staff.CStaff"
local CCommon = JRequire "Dev.Common.CCommon"

local _M = Class()
local _P = {}

local STAFFMAXCOLOR = Csv.Const(Define.Const.StaffMax)[4]
local LVLUP_ONEKEY = 10 -- 一键升多少级
local PromoteItemId = 22
local PromoteUseType = 6

--界面构建
function _M:ctor(parent,id)
	self._RootNode = parent
	local moudle = JGuiManager.GetMoudle(self._RootNode, "M_Staff_Overview", WindowType.UI, 0)
	self.mMoudle = moudle
	self.mStaffid = id
	local person = Csv.Personnel[id]

	moudle:Get("textDetail").Text = Csv.Text("staff_detail")
	moudle:Get("Property").Text = Csv.Text("staff_property")
	moudle:Get("Level_0").Text = Csv.Text("staff_attriT1")
	moudle:Get("LevelData_0").Text = person.age
	moudle:Get("Speciality_0").Text = Csv.Text("staff_attriT2")
	moudle:Get("SpecialityData_0").Text = person.zhiwei
	moudle:Get("Property_0").Text = Csv.Text("staff_attriT3")
	moudle:Get("PropertyData_0").Text = person.tedian
	moudle:Get("Attri1_0").Text = Csv.Text("staff_attriT4")
	moudle:Get("Attri1Data_0").Text = person.koutou
	moudle:Get("Attri2_0").Text = Csv.Text("staff_attriT5")
	moudle:Get("Attri2Data_0").Text = person.tips

	self.TextMax = moudle:Get("MaxText")
	self.TextMax.Text = Csv.Text("staff_lvmax")

	self.TextExpTitle1 = moudle:Get("SliderText0")
	self.TextExpTitle2 = moudle:Get("SliderText2")
	self.TextExpTitle1.Text = Csv.Text("staff_title0")
	self.TextExpTitle2.Text = Csv.Text("staff_title2")

	local BtnDetails = moudle:Get("BtnDetails")
	BtnDetails:AddOnButton(function ( ... )
		SoundMgr.Play(10001)
		-- WindowMgr.Create("UStaffAttributePop",id)
		WindowMgr.Call("UStaffDetails", "OnClickDesc")
		end, nil, 0.9)

	local addButton = moudle:Get("Add_Btn")
	addButton:AddOnButton(function ( ... )
		SoundMgr.Play(10001)

		local listData = MBag.GetBagItemsByUseType(PromoteUseType, true)
		if listData == nil or next(listData) == nil then
			WindowMgr.Create("UItemTrack", PromoteItemId, 1)
		else
			WindowMgr.Create("UStaffQuickPromotion", id)
		end
	end, nil, 1.2)

	moudle:Get("SSJ").Text = Csv.Text("staff_lvlup_10", {num = LVLUP_ONEKEY})
	local GOU = moudle:Get("GOU")
	GOU.Activity = MStaff.IsLvlUp10(self.mStaffid)
	local XZ = moudle:Get("XZ")
	XZ:AddOnButton(function ( ... )
		SoundMgr.Play(10001)
		if GOU.Activity == true then
			GOU.Activity = false
			MStaff.SetLvlUp10(self.mStaffid, false)
		else
			GOU.Activity = true
			MStaff.SetLvlUp10(self.mStaffid, true)
			CCommon.ShowError(Csv.Text("staff_lvlup_10_tips", {num = LVLUP_ONEKEY}))
		end
		local staffData = MStaff.GetStaffDataByID(id)
		_P.SetLvlUpInfo(self, staffData)
		self:SetExpSlider(id,staffData.levelexp,staffData.level,false,false,false)
		end, nil, 0.9)
	
	local BtnUp = moudle:Get("BtnUp")
	BtnUp:AddOnButton(function ( ... )
		SoundMgr.Play(10001)
		local Data = MStaff.GetStaffDataByID(id)
		if Data.level >= Csv.ColorUp[Data.color].lvMax and Data.color < STAFFMAXCOLOR then
			WindowMgr.Create("UStaffPromotePop",id)
		else
			local production = MBag.GetItemNum(Define.AssetsType.Coin)
			if production > 0 then
				local lvlupCount = MStaff.IsLvlUp10(self.mStaffid) == false and 1 or LVLUP_ONEKEY
				CStaff.StaffLevelUp(id, lvlupCount)
				BtnUp.RaycastTarget = false
			else
				if not MBag.CheckItemEnough(Define.AssetsType.Coin, 1) then
					return
				end
			end
		end
		end, nil, 0.9)
	
		self:OnCreateData(id)

	local data = MStaff.GetStaffDataByID(id)
	if data.level >= Csv.ColorUp[STAFFMAXCOLOR].lvMax then
		self.mLastVal = 1
	else
		local num,val = math.modf(data.levelexp/Csv.LevelUp[data.level].cost)
		self.mLastVal = val
	end
	self:SetExpSlider(id,data.levelexp,data.level,false,false,false)
end

function _P.SetLvlUpInfo(self, data)
	local TextBtnUp = self.mMoudle:Get("C_text")
	TextBtnUp.Text = ((MStaff.IsLvlUp10(self.mStaffid) == false and Csv.Text("staff_up")) or Csv.Text("staff_lvlup_10", {num = LVLUP_ONEKEY}))
	if data.level >= Csv.ColorUp[data.color].lvMax and data.color >= STAFFMAXCOLOR then
		self.TextMax.Activity = true
		self.mMoudle:Get("BtnUp").Activity = false
		self.mMoudle:Get("XZ").Activity = false
		MStaff.SetLvlUp10(self.mStaffid, false)
		self.mMoudle:Get("GOU").Activity = MStaff.IsLvlUp10(self.mStaffid)
	else
		if data.level >= Csv.ColorUp[data.color].lvMax then
			TextBtnUp.Text = Csv.Text("staff_max_up")
		end
	end
end

function _M:SetExpSlider(id,exp,level,isAnimate,isUp,isGod)
	local moudle = self.mMoudle
	local slider = moudle:Get("Fill")
	local textSlider = moudle:Get("SliderText")
	if level >= Csv.ColorUp[STAFFMAXCOLOR].lvMax then
		if isAnimate then
			SoundMgr.PlayNonStopUI(10010)
			local tween = slider:DOFillAmount(1,0.3)
			tween:OnComplete(function(...)
				self:OnCreateData(id)
				textSlider.Text = Csv.Text("staff_max")
				self.TextExpTitle1.Activity = false
				self.TextExpTitle2.Activity = false
				_P.OnPlayLevelUpAnim(self)
			end)
		else
			slider.FillAmount = 1
			textSlider.Text = Csv.Text("staff_max")
			self.TextExpTitle1.Activity = false
			self.TextExpTitle2.Activity = false
		end
		self.mLastVal = 1
		return
	else
		self.TextExpTitle1.Activity = true
		self.TextExpTitle2.Activity = true
	end
	local lvlupCount = ((MStaff.IsLvlUp10(self.mStaffid) == false and 1) or LVLUP_ONEKEY)
	local maxExp = _P.GetLvlUpExpNeed(id, level, lvlupCount) --Csv.LevelUp[level].cost
	local num,val = math.modf(exp/maxExp)
	if slider ~= nil then
		slider:DOKill()
		slider.FillAmount = 0
	end
	moudle.SelfRect:DOKill()
	if isGod then
		local tween
		SoundMgr.PlayNonStopUI(10010)
		tween = slider:DOFillAmount(1,(1 - self.mLastVal)*0.3)
		tween:OnComplete(function(...)
			slider.FillAmount = 0
			moudle:Get("BtnUp").RaycastTarget = true
			self:OnCreateData(id)
			_P.OnPlayLevelUpAnim(self)
		end)
		self.mTween = tween
		SoundMgr.Play(10004)
		local nodeTrans = moudle:Get("EffectNodeGod")
		CCommon.PlayEffectGod(nodeTrans,Define.SysId.Staff)
	else
		if isAnimate then
			local tween
			if isUp then
				SoundMgr.PlayNonStopUI(10010)
				tween = slider:DOFillAmount(1,(1 - self.mLastVal)*0.3)
				tween:OnComplete(function(...)
					slider.FillAmount = 0
					moudle:Get("BtnUp").RaycastTarget = true
					self:OnCreateData(id)
					_P.OnPlayLevelUpAnim(self)
				end)
			else
				tween = slider:DOFillAmount(val,(val - self.mLastVal)*0.3)
				tween:OnComplete(function(...)
					moudle:Get("BtnUp").RaycastTarget = true
					self:OnCreateData(id)
				end)
			end
			self.mTween = tween
		else
			slider.FillAmount = val
		end
	end
	local upNeeded = maxExp - exp
	local have = MBag.GetItemNum(Define.AssetsType.Coin)
	if have >= upNeeded then
		textSlider.Text = Csv.Text("staff_needG",{num = upNeeded})
	else
		textSlider.Text = Csv.Text("staff_needR",{num = upNeeded})
	end
	self.mLastVal = val
end

function _M:OnCreateData(id)
	local data = MStaff.GetStaffDataByID(id)
	local csvColorUp = Csv.ColorUp[data.color]
	local moudle = self.mMoudle
	moudle:Get("LevelData").Text = Csv.Text("staff_level2",{num = data.level,max = csvColorUp.lvMax})
	moudle:Get("PropertyData").Text = data.allAttr.Wuli + data.allAttr.Zhili + data.allAttr.Zhengzhi + data.allAttr.Meili
	moudle:Get("Attri1Data").Text = data.allAttr.Wuli
	moudle:Get("Attri2Data").Text = data.allAttr.Zhili
	moudle:Get("Attri3Data").Text = data.allAttr.Zhengzhi
	moudle:Get("Attri4Data").Text = data.allAttr.Meili

	moudle:Get("redPoint_colorup").Activity = MStaff.GetRedPointColorUp(id)

	_P.SetLvlUpInfo(self, data)
	-- local imgPos = moudle:Get("PositionIcon")
	-- if csvColorUp ~= nil and csvColorUp.posIcon ~= nil then
	-- 	imgPos.Activity = true
	-- 	imgPos.SpriteName = csvColorUp.posIcon
	-- else
	-- 	imgPos.Activity = false
	-- end
end

function _P.GetLvlUpExpNeed(id, lvl, lvlupCount)
	local expNeed = Csv.LevelUp[lvl].cost
	if lvlupCount > 1 then
		local maxLvl = lvl + lvlupCount-1
		local data = MStaff.GetStaffDataByID(id)
		local csvColorUp = Csv.ColorUp[data.color]
		if lvl == csvColorUp.lvMax then
			maxLvl = lvl + lvlupCount - 1
		elseif maxLvl > csvColorUp.lvMax then
			maxLvl = csvColorUp.lvMax - 1
		end

		expNeed = 0
		for index = lvl, maxLvl do
			if Csv.LevelUp[index] ~= nil and Csv.LevelUp[index].cost ~= nil then
				expNeed = expNeed + Csv.LevelUp[index].cost
			end
		end
	end

	return expNeed
end

function _P.OnPlayLevelUpAnim(self)
	WindowMgr.Call("UStaffDetails", "OnPlayLevelUpAnim")
end

function _M:Destroy()
	local moudle = self.mMoudle
	if moudle ~= nil then
		moudle:Destroy()
	end
end

return _M
