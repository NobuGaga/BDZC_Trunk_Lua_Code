local WindowBase = JRequire "Libs.WindowMgr.WindowBase"
local MStaff = JRequire "Dev.Staff.MStaff"
local WindowType = JRequire "Libs.WindowMgr.WindowType"
local SoundMgr = JRequire "Libs.Sound.SoundMgr"
local _M = Class(WindowBase)
local _P = {}
local _R = {}

local Default_Img = "yg_sx_002"
local Select_Img = "yg_sx_003"

function _M:OnPopCreate( ... )
	self:OnCreate(...)
end

--事件派发
function _M:Dispatch(funcName, ...)
	local fun = _R[funcName]
	if fun ~= nil then 
		fun(self, ...)
	end
end

--界面构建
function _M:OnCreate(...)
	--MStaff.LoadStaffsSortType() --加载员工排序方式(20180508又说不存本地因为营销新手教程)

	local moudle = self:CreateMoudle(self._RootNode, "M_Staff_UMain")
	self.mMoudle = moudle

	moudle:Get("SSJ").Text = Csv.Text("staff_had")
	self.GOU = moudle:Get("GOU")
	self.GOU.Activity = MStaff.gou
	local XZ = moudle:Get("XZ")
	XZ:AddOnButton(function ( ... )
		SoundMgr.Play(10001)
		if MStaff.gou == true then
			MStaff.gou = false
			self.GOU.Activity = false
		else
			MStaff.gou = true
			self.GOU.Activity = true
		end
		_P.CreateStaffList(self)
		end, nil, 0.9)

	self.mRawTableItems = {}
	self.mRawTableItems2 = {} -- 没有获得的员工
	_P.CreateStaffList(self)
	local TextTitle = moudle:Get("C_Text")
	TextTitle.Text = Csv.Text("staff_title")
	local TextStaffNum = moudle:Get("StaffNum")
	TextStaffNum.Text = Csv.Text("staff_num")
	moudle:Get("NumText").Text = tostring(MStaff.StaffNum)

	local BtnClose = moudle:Get("C_Back_Btn")
	BtnClose:AddOnButton(function ( ... )
		SoundMgr.Play(10002)
		self:Destroy()
		end, nil, 1.2)

	local BtnRule = moudle:Get("C_Full_Help_Btn")
	BtnRule:AddOnButton(function ( ... )
		SoundMgr.Play(10001)
		WindowMgr.Create("URuleTips",Define.SysId.Staff)
		end, nil, 1.2)

	--排序
	self.isSorts = false
	
	moudle:Get("Order").Text = Csv.Text("staff_order")
	for i = 1,5,1 do
		moudle:Get("ordertext"..i).Text = Csv.Text("staff_order_"..i) 
	end

	moudle:Get("order1"):AddOnButton(function()
		_P.ClickSortItem(self,MStaff.StaffsSort.default)
	end)
	moudle:Get("order2"):AddOnButton(function()
		_P.ClickSortItem(self,MStaff.StaffsSort.level)
	end)
	moudle:Get("order3"):AddOnButton(function()
		_P.ClickSortItem(self,MStaff.StaffsSort.attr)
	end)
	moudle:Get("order4"):AddOnButton(function()
		_P.ClickSortItem(self,MStaff.StaffsSort.apitude)
	end)
	moudle:Get("order5"):AddOnButton(function()
		_P.ClickSortItem(self,MStaff.StaffsSort.star)
	end)
end

function _R.ChangeStaffLv(self,staffid)
	local staffitem = self.mRawTableItems[staffid]
	local data = MStaff.GetStaffDataByID(staffid)
	if staffitem ~= nil and data ~= nil then
		staffitem.moudle:Get("Level").Text = data.level
	end
end

function _R.ChangeStaffColor(self,staffid)
	local staffitem = self.mRawTableItems[staffid]
	local data = MStaff.GetStaffDataByID(staffid)
	if staffitem ~= nil and data ~= nil then
		staffitem.moudle:Get("BG_2").SpriteName = MStaff.Color2Image[data.color]
	end
end

function _P.CreateStaffList(self)
	for i = 1,5 do
		self.mMoudle:Get("order"..i).SpriteName = Default_Img
	end
	if MStaff.SortType ~= nil then
		self.mMoudle:Get("order"..(MStaff.SortType + 1)).SpriteName = Select_Img
	end

	local contentTransform = self.mMoudle:Get("Content")
	contentTransform:DestroyChildren()

	local staffTableDatas = _P.GetSortStaffs(self,MStaff.StaffTable,MStaff.SortType)
	for k,v in ipairs(staffTableDatas) do
		self.mRawTableItems[v.id] = _P.OnCreateItem(v,contentTransform)
	end
	self.mSortStaffDatas = staffTableDatas

	if Csv.Personnel ~= nil and MStaff.gou == false then
		staffTableDatas = _P.GetSortStaffsNotObtained(self,MStaff.StaffTable,MStaff.SortType)
		for k,v in ipairs(staffTableDatas) do
			self.mRawTableItems2[v.id] = _P.OnCreateItem(v,contentTransform)
		end
	else
		self.mRawTableItems2 = {}
	end
end

function _P.ClickSortItem(self,sortType)
	--MStaff.SortType = sortType
	MStaff.SetStaffsSortType(sortType)
	_P.CreateStaffList(self)
end

function _P.GetSortStaffsNotObtained(self,sortType)
	local sortTable = {}
	for index, v in pairs(Csv.Personnel) do
		if self.mRawTableItems[v.id] == nil then
			table.insert(sortTable,v)
		end
	end

	table.sort(sortTable,function(a,b)
		return a.id < b.id 
	end)

	local sortType = MStaff.SortType 
	--属性排序
	--按照属性(实力)》综合资质》品质》星数》id排序
	if sortType == MStaff.StaffsSort.attr then
		table.sort(sortTable,function(a,b)
			local aAttr = MStaff.GetAllAttrNotObtained(a.id)
			local bAttr = MStaff.GetAllAttrNotObtained(b.id)
			if aAttr == bAttr then
				local aZiZhi = MStaff.GetAllApitudeNotObtained(a.id)
				local bZiZhi = MStaff.GetAllApitudeNotObtained(b.id)
				if aZiZhi == bZiZhi then
					if a.color == b.color then
						local aStar = Csv.Personnel[a.id].star
						local bStar = Csv.Personnel[b.id].star
						if aStar == bStar then
							return a.id < b.id
						else
							return aStar > bStar
						end
					else
						return a.color > b.color
					end
				else
					return aZiZhi > bZiZhi
				end
			else
				return aAttr > bAttr
			end
		end)
		return sortTable
	--品质排序
	--按照品质》属性》综合资质》星数》id排序
	elseif sortType == MStaff.StaffsSort.color then
		table.sort(sortTable,function(a,b)
			if a.color == b.color then
				local aAttr = MStaff.GetAllAttrNotObtained(a.id)
				local bAttr = MStaff.GetAllAttrNotObtained(b.id)
				if aAttr == bAttr then
					local aZiZhi = MStaff.GetAllApitudeNotObtained(a.id)
					local bZiZhi = MStaff.GetAllApitudeNotObtained(b.id)
					if aZiZhi == bZiZhi then
						local aStar = Csv.Personnel[a.id].star
						local bStar = Csv.Personnel[b.id].star
						if aStar == bStar then
							return a.id < b.id
						else
							return aStar > bStar
						end
					else
						return aZiZhi > bZiZhi
					end
				else
					return aAttr > bAttr
				end
			else
				return a.color > b.color
			end
		end)
		return sortTable
	--资质排序
	--按照综合资质》属性》品质》星数》id排序
	elseif sortType == MStaff.StaffsSort.apitude then
		table.sort(sortTable,function(a,b)
			local aZiZhi = MStaff.GetAllApitudeNotObtained(a.id)
			local bZiZhi = MStaff.GetAllApitudeNotObtained(b.id)
			if aZiZhi == bZiZhi then
				local aAttr = MStaff.GetAllAttrNotObtained(a.id)
				local bAttr = MStaff.GetAllAttrNotObtained(b.id)
				if aAttr == bAttr then
					if a.color == b.color then
						local aStar = Csv.Personnel[a.id].star
						local bStar = Csv.Personnel[b.id].star
						if aStar == bStar then
							return a.id < b.id
						else
							return aStar > bStar
						end
					else
						return a.color > b.color
					end
				else
					return aAttr > bAttr
				end
				
			else
				return aZiZhi > bZiZhi
			end
		end)
		return sortTable
	--星数排序
	--按照星级》属性》综合资质》品质》id排序
	elseif sortType == MStaff.StaffsSort.star then
		table.sort(sortTable,function(a,b)
			local aStar = Csv.Personnel[a.id].star
			local bStar = Csv.Personnel[b.id].star
			if aStar == bStar then
				local aAttr = MStaff.GetAllAttrNotObtained(a.id)
				local bAttr = MStaff.GetAllAttrNotObtained(b.id)
				if aAttr == bAttr then
					local aZiZhi = MStaff.GetAllApitudeNotObtained(a.id)
					local bZiZhi = MStaff.GetAllApitudeNotObtained(b.id)
					if aZiZhi == bZiZhi then
						if a.color == b.color then
							return a.id < b.id
						else
							return a.color > b.color
						end
					else
						return aZiZhi > bZiZhi
					end
				else
					return aAttr > bAttr
				end
			else
				return aStar > bStar
			end
		end)
		return sortTable
	else
		--id排序
		return sortTable
	end
end

function _P.GetSortStaffs(self,rawTable,sortType)
	local sortTable = {}
	for k,v in pairs(rawTable) do
		table.insert(sortTable,v)
	end

	table.sort(sortTable,function(a,b)
		return a.id < b.id 
	end)
	
	local sortType = MStaff.SortType 
	--属性排序
	--按照属性(实力)》综合资质》品质》星数》id排序
	if sortType == MStaff.StaffsSort.attr then
		table.sort(sortTable,function(a,b)
			local aAttr = MStaff.GetAllAttr(a.id)
			local bAttr = MStaff.GetAllAttr(b.id)
			if aAttr == bAttr then
				local aZiZhi = MStaff.GetAllApitude(a.id)
				local bZiZhi = MStaff.GetAllApitude(b.id)
				if aZiZhi == bZiZhi then
					if a.color == b.color then
						local aStar = Csv.Personnel[a.id].star
						local bStar = Csv.Personnel[b.id].star
						if aStar == bStar then
							return a.id < b.id
						else
							return aStar > bStar
						end
					else
						return a.color > b.color
					end
				else
					return aZiZhi > bZiZhi
				end
			else
				return aAttr > bAttr
			end
		end)
		return sortTable
	--等级排序
	--按照等级》属性》综合资质》星数》id排序
	elseif sortType == MStaff.StaffsSort.level then
		table.sort(sortTable,function(a,b)
			if a.level == b.level then
				local aAttr = MStaff.GetAllAttr(a.id)
				local bAttr = MStaff.GetAllAttr(b.id)
				if aAttr == bAttr then
					local aZiZhi = MStaff.GetAllApitude(a.id)
					local bZiZhi = MStaff.GetAllApitude(b.id)
					if aZiZhi == bZiZhi then
						local aStar = Csv.Personnel[a.id].star
						local bStar = Csv.Personnel[b.id].star
						if aStar == bStar then
							return a.id < b.id
						else
							return aStar > bStar
						end
					else
						return aZiZhi > bZiZhi
					end
				else
					return aAttr > bAttr
				end
			else
				return a.level > b.level
			end
		end)
		return sortTable
	--资质排序
	--按照综合资质》属性》品质》星数》id排序
	elseif sortType == MStaff.StaffsSort.apitude then
		table.sort(sortTable,function(a,b)
			local aZiZhi = MStaff.GetAllApitude(a.id)
			local bZiZhi = MStaff.GetAllApitude(b.id)
			if aZiZhi == bZiZhi then
				local aAttr = MStaff.GetAllAttr(a.id)
				local bAttr = MStaff.GetAllAttr(b.id)
				if aAttr == bAttr then
					if a.color == b.color then
						local aStar = Csv.Personnel[a.id].star
						local bStar = Csv.Personnel[b.id].star
						if aStar == bStar then
							return a.id < b.id
						else
							return aStar > bStar
						end
					else
						return a.color > b.color
					end
				else
					return aAttr > bAttr
				end
				
			else
				return aZiZhi > bZiZhi
			end
		end)
		return sortTable
	--星数排序
	--按照星级》属性》综合资质》品质》id排序
	elseif sortType == MStaff.StaffsSort.star then
		table.sort(sortTable,function(a,b)
			local aStar = Csv.Personnel[a.id].star
			local bStar = Csv.Personnel[b.id].star
			if aStar == bStar then
				local aAttr = MStaff.GetAllAttr(a.id)
				local bAttr = MStaff.GetAllAttr(b.id)
				if aAttr == bAttr then
					local aZiZhi = MStaff.GetAllApitude(a.id)
					local bZiZhi = MStaff.GetAllApitude(b.id)
					if aZiZhi == bZiZhi then
						if a.color == b.color then
							return a.id < b.id
						else
							return a.color > b.color
						end
					else
						return aZiZhi > bZiZhi
					end
				else
					return aAttr > bAttr
				end
			else
				return aStar > bStar
			end
		end)
		return sortTable
	else
		--id排序
		return sortTable
	end
end

function _P.OnCreateItem(data,contentTransform)
	local staff = {}
	local itemMoudle = JGuiManager.GetMoudle(contentTransform, "M_Staff_Item", WindowType.UI, 0)
	if MStaff.NoStaff(data.id) then
		itemMoudle:Get("BG_2").IsGray = true
		itemMoudle:Get("Icon").IsGray = true
	else
		itemMoudle:Get("BG_2").IsGray = false
		itemMoudle:Get("Icon").IsGray = false
	end
	local csvPerson = Csv.Personnel[data.id]

	local ImgIcon = itemMoudle:Get("Icon")
	ImgIcon.SpriteName = csvPerson.asset2
	--ImgIcon.LocalPosition = Vector2(csvPerson.headPos[1],csvPerson.headPos[2])

	itemMoudle:Get("BG_2").SpriteName = MStaff.Color2Image[data.color]

	itemMoudle:Get("BG_2"):AddOnButton(function ( ... )
		SoundMgr.Play(10001)
		_P.OnClickItem(data.id)
		end, nil, 1)

	local TextLevel = itemMoudle:Get("Level")
	TextLevel.Text = data.level

	local TextName = itemMoudle:Get("Name")
	TextName.Text = MStaff.GetStaffName(data.id)--csvPerson.name

	local ImgRedPoint = itemMoudle:Get("RedPoint")
	ImgRedPoint.Activity = MStaff.GetRedPointState(data.id)

	for i = 1,7 do
		local imgStar = itemMoudle:Get("Star"..i)
		if imgStar ~= nil then
			imgStar.Activity = false
		end
	end

	for i = 1,csvPerson.star do
		itemMoudle:Get("Star"..i).Activity = true
	end

	for i = 1,4 do
		local imgZizhi = itemMoudle:Get("Zizhi"..i)
		if imgZizhi ~= nil then
			imgZizhi.Activity = false
		end
	end

	for k,v in ipairs(csvPerson.specialtyIcon) do
		local imgZizhi = itemMoudle:Get("Zizhi"..k)
		if imgZizhi ~= nil then
			imgZizhi.Activity = true
			imgZizhi.SpriteName = v
		end
	end

	staff.moudle = itemMoudle

	return staff
end

function _P.OnClickItem(id)
	if id ~= nil then
		MStaff.LastChooseStaff = id
		if MStaff.NoStaff(id) then
			WindowMgr.Create("UStaffDetailsNotObtained",id)
		else
			WindowMgr.Create("UStaffDetails",id)
		end
	end
end

function _R.ResetPoint(self)
	local staffTable = MStaff.StaffTable
	for k,v in pairs(staffTable) do
		if v.id ~= nil then
			local moudle = self.mRawTableItems[v.id].moudle
			moudle:Get("RedPoint").Activity = MStaff.GetRedPointState(v.id)
		end
	end
end

function _R.RefreshStaffName(self,id)
	local staffItem = self.mRawTableItems[id]
	if staffItem ~= nil then
		local moudle = staffItem.moudle
		local TextName = moudle:Get("Name")
		TextName.Text = MStaff.GetStaffName(id)
	end
end

return _M